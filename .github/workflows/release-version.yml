name: 'Release - Semantic Version'
on:
  workflow_run:
    workflows: ['Quality - Checks']
    types: [completed]
  workflow_dispatch:
    inputs:
      targetEnv:
        description: 'Environment suffix for tag'
        required: true
        type: choice
        options: [dev, test, uat, prod]
        default: dev
permissions:
  contents: write
  issues: write
  pull-requests: write
jobs:
  version:
    name: 'Version â€¢ semantic-release'
    # Auto-run when CI succeeds OR manual dispatch
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      || github.event_name == 'workflow_dispatch'
    runs-on: [self-hosted, linux, x64, core]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_run'
            && github.event.workflow_run.head_sha
            || github.ref }}
      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 22
      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --prefer-online --no-audit --no-fund --no-package-lock
          fi
      - name: Run semantic-release (env suffix)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ENV_SUFFIX="${{ github.event_name == 'workflow_dispatch' && inputs.targetEnv || 'dev' }}"
          # Produces tags like: v1.2.3.dev / v1.2.3.test / v1.2.3.uat / v1.2.3.prod
          npx semantic-release --ci --debug --tag-format "v\${version}.${ENV_SUFFIX}"
