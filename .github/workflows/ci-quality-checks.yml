name: 'Quality - Checks'
on:
  push:
    branches-ignore: [release]
jobs:
  commit-check:
    name: 'Commit - Check'
    permissions:
      checks: write
      pull-requests: write
      contents: write
    timeout-minutes: 5
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v5
      - uses: commit-check/commit-check-action@v0.5.4
        with:
          message: true
          branch: true
          author-name: true
          author-email: true
          commit-signoff: false
          dry-run: false
          job-summary: true
  code-formatting:
    name: 'Code - Formatting'
    needs: commit-check
    runs-on: [self-hosted, linux, x64, mtn-one]
    permissions:
      contents: read
      actions: read
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com/
          always-auth: true
      - name: Install dependencies
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
        run: |
          npm config set prefer-offline false

          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --prefer-online --no-audit --no-fund --no-package-lock
          fi
      - name: Check format
        run: npm run format:check
  code-linting:
    name: 'Code - Linting'
    needs: commit-check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com/
          always-auth: true
      - name: Install dependencies
        run: |
          npm config set prefer-offline false

          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --prefer-online --no-audit --no-fund --no-package-lock
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
      - name: Check Linting
        run: npm run lint:check
  naming-conventions:
    name: 'Code - Naming Conventions'
    needs: commit-check
    permissions:
      contents: read
      actions: read
    runs-on: [self-hosted, linux, x64, mtn-one]
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com/
          always-auth: true
      - name: Check file naming conventions
        run: npm run naming:convention
  package-audit:
    name: 'Code - Packages Audit'
    needs: code-formatting
    permissions:
      contents: read
      actions: read
    runs-on: [self-hosted, linux, x64, mtn-one]
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com/
      - name: Install dependencies
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
        run: |
          npm i --package-lock-only
      - name: Security Audit (Production Dependencies)
        run: npm audit --production --audit-level=high
  secrets-leaks:
    name: 'Security - Secrets Leaks'
    needs: code-linting
    permissions:
      contents: read
      actions: read
    runs-on: [self-hosted, linux, x64, mtn-one]
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Clean temp Gitleaks artifacts
        run: rm -f /tmp/gitleaks.tmp || true
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}}
        with:
          args: detect --source . --no-git --redact --exit-code 1
  lockfile-lint:
    name: 'SupplyChain - Lockfile Validation'
    needs: secrets-leaks
    permissions:
      contents: read
      actions: read
    runs-on: [self-hosted, linux, x64, mtn-one]
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com/
      - name: Lint lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
        run: |
          npm config set prefer-offline false

          if [ -f package-lock.json ]; then
            npm ci --no-audit --no-fund
          else
            npm install --prefer-online --no-audit --no-fund --no-package-lock
          fi

          npx lockfile-lint --path package-lock.json --type npm --validate-https \
            --allowed-hosts npm.pkg.github.com,registry.npmjs.org
  package-sbom:
    name: 'Code - SBOM Generation'
    needs: secrets-leaks
    permissions:
      contents: read
      actions: read
    runs-on: [self-hosted, linux, x64, mtn-one]
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com/
          always-auth: true
      - name: Install dependencies
        shell: bash
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
        run: |
          npm i --prefer-online --no-audit --no-fund
      - name: Generate SBOM
        run: |
          npm ls react react-dom react-test-renderer --depth=0 || true

          npx @cyclonedx/cyclonedx-npm@latest \
            --output-file sbom.cdx.json \
            --spec-version 1.5 \
            --omit dev \
            -ignore-npm-erros
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.cdx.json
          retention-days: 7
  sbom-vuln-scan:
    name: 'Security - SBOM Vulnerability Scan'
    needs: package-sbom
    permissions:
      contents: read
      actions: read
    runs-on: [self-hosted, linux, x64, mtn-one]
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com/
          always-auth: true
      - uses: actions/download-artifact@v4
        with:
          name: sbom-cyclonedx
          path: .
      - uses: google/osv-scanner-action/analyze@v2
        with:
          sbom: sbom.cdx.json
          fail-on: HIGH
  test:
    name: 'Tests - Integration'
    needs: naming-conventions
    runs-on: [self-hosted, linux, x64, mtn-one]
    permissions:
      contents: read
      actions: read
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com/
          always-auth: true
      - name: Install dependencies
        run: npm install --no-audit --progress=false
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
      - name: Run unit tests
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
        if: env.NODE_AUTH_TOKEN != null
        run: npm test
  test-coverage:
    name: 'Tests - Coverage'
    needs: test
    permissions:
      checks: write
      pull-requests: write
      contents: write
    runs-on: [self-hosted, linux, x64, mtn-one]
    timeout-minutes: 10
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com
          always-auth: true
      - name: Install dependencies
        run: npm install --no-audit --progress=false
        env:
          NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
      - name: Run unit test
        run: npm run test
      - name: Check artifacts build
        run: npm run build
      - name: Add test coverage report in PR
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          github-token: ${{ secrets.PACKAGES_TOKEN }}
